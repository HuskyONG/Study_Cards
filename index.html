<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Counting Cards</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â™ </text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f5f0eb;--surface:#fefcf9;--accent:#c17f5a;--accent2:#7a9e87;
    --text:#3a2e28;--muted:#9a8a7e;--card-back:#e8ddd5;--border:#e0d4cc;
    --shadow:rgba(100,70,50,0.12);--red:#c0443a;--black:#2a2420;
    --disabled:#d0c8c0;--disabled-text:#b0a89e;
    --pomo-work:#c17f5a;--pomo-short:#7a9e87;--pomo-long:#5a7fa0;
  }
  body[data-theme="warm"]     {--bg:#f5f0eb;--surface:#fefcf9;--accent:#c17f5a;--accent2:#7a9e87;--text:#3a2e28;--muted:#9a8a7e;--card-back:#e8ddd5;--shadow:rgba(100,70,50,0.12);}
  body[data-theme="dark"]     {--bg:#1a1612;--surface:#635446;--accent:#d4956a;--accent2:#8fb39c;--text:#f2eae4;--muted:#b8a99e;--card-back:#796857;--shadow:rgba(0,0,0,0.4);}
  body[data-theme="midnight"] {--bg:#0d0f1a;--surface:#30365c;--accent:#7c6fff;--accent2:#4db6ff;--text:#e8ebff;--muted:#9aa3d4;--card-back:#545b85;--shadow:rgba(0,0,0,0.5);}
  body[data-theme="forest"]   {--bg:#0f1a12;--surface:#33533e;--accent:#5dbd6e;--accent2:#8ad4a0;--text:#e6f4ea;--muted:#a3c4ad;--card-back:#508b65;--shadow:rgba(0,0,0,0.45);}

  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Lato',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:24px 16px 80px;
    background-image:radial-gradient(ellipse at 20% 10%,#e8ddd5 0%,transparent 50%),radial-gradient(ellipse at 80% 90%,#dde8dd 0%,transparent 50%);}
  h1{font-family:'Playfair Display',serif;font-size:2.2rem;text-align:center;color:var(--text);margin-bottom:4px;letter-spacing:-0.5px;}
  .subtitle{text-align:center;color:var(--muted);font-size:0.9rem;margin-bottom:20px;font-weight:300;}

  /* THEME SWITCHER */
  .theme-switcher{position:fixed;top:16px;right:16px;z-index:50;display:flex;gap:6px;background:var(--surface);border-radius:50px;padding:6px;box-shadow:0 2px 16px var(--shadow);border:1px solid var(--border);}
  .theme-btn{width:28px;height:28px;border-radius:50%;border:2px solid rgba(0,0,0,0.15);cursor:pointer;transition:all 0.2s;display:block;padding:0;}
  .theme-btn:hover{transform:scale(1.15);}
  .theme-btn.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent);}
  .theme-btn[data-theme="warm"]{background:linear-gradient(135deg,#f5f0eb,#c17f5a);}
  .theme-btn[data-theme="dark"]{background:linear-gradient(135deg,#1a1612,#d4956a);}
  .theme-btn[data-theme="midnight"]{background:linear-gradient(135deg,#0d0f1a,#7c6fff);}
  .theme-btn[data-theme="forest"]{background:linear-gradient(135deg,#0f1a12,#5dbd6e);}

  /* TROPHY BADGE â€” clickable to open progress modal */
  .deck-completions-badge{position:fixed;top:16px;left:16px;z-index:50;background:var(--surface);border-radius:50px;padding:6px 14px 6px 10px;
    box-shadow:0 2px 16px var(--shadow);border:1px solid var(--border);display:flex;align-items:center;gap:7px;
    cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
  .deck-completions-badge:hover{transform:scale(1.05);box-shadow:0 4px 20px var(--shadow);}
  .badge-icon{font-size:1.1rem;}
  .badge-content{display:flex;flex-direction:column;line-height:1.2;}
  .badge-num{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--accent);}
  .badge-label{font-size:0.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);}
  @keyframes badge-pop{0%{transform:scale(1)}40%{transform:scale(1.3)}70%{transform:scale(0.92)}100%{transform:scale(1)}}
  .badge-animate{animation:badge-pop 0.5s cubic-bezier(0.34,1.56,0.64,1);}

  /* STREAK BADGE */
  .streak-badge{position:fixed;top:62px;left:16px;z-index:50;background:var(--surface);border-radius:50px;
    padding:5px 12px 5px 10px;box-shadow:0 2px 12px var(--shadow);border:1px solid var(--border);
    display:flex;align-items:center;gap:6px;cursor:default;}
  .streak-num{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;color:var(--accent);}
  .streak-sub{font-size:0.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);}

  /* HELP BUTTON */
  .help-btn{position:fixed;bottom:24px;left:16px;z-index:50;width:36px;height:36px;border-radius:50%;
    background:var(--surface);border:1.5px solid var(--border);box-shadow:0 2px 12px var(--shadow);
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--muted);transition:all 0.2s;}
  .help-btn:hover{border-color:var(--accent);color:var(--accent);transform:scale(1.1);}

  /* TABS */
  .tabs-nav{max-width:600px;margin:0 auto 20px;display:flex;background:var(--surface);border-radius:14px;padding:5px;box-shadow:0 2px 12px var(--shadow);}
  .tab-btn{flex:1;padding:10px 0;border:none;background:transparent;font-family:'Lato',sans-serif;font-size:0.88rem;font-weight:700;color:var(--muted);border-radius:10px;cursor:pointer;transition:all 0.22s;letter-spacing:0.5px;}
  .tab-btn.active{background:var(--accent);color:white;box-shadow:0 2px 10px rgba(193,127,90,0.35);}
  .tab-btn:not(.active):hover{color:var(--accent);background:rgba(193,127,90,0.08);}
  .tab-panel{display:none;}.tab-panel.active{display:block;}

  /* USERS */
  .user-section{max-width:600px;margin:0 auto 16px;background:var(--surface);border-radius:16px;padding:14px 16px;box-shadow:0 2px 12px var(--shadow);}
  .user-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .user-section-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .users-list{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .user-chip{display:flex;align-items:center;gap:6px;padding:6px 14px 6px 10px;border-radius:50px;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;transition:all 0.2s;font-size:0.85rem;font-weight:700;color:var(--muted);user-select:none;}
  .user-chip:hover{border-color:var(--accent);color:var(--accent);}
  .user-chip.active{background:var(--accent);border-color:var(--accent);color:white;box-shadow:0 2px 10px rgba(193,127,90,0.35);}
  .user-chip .user-avatar{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;background:var(--card-back);color:var(--muted);}
  .user-chip.active .user-avatar{background:rgba(255,255,255,0.25);color:white;}
  .user-chip .delete-user{margin-left:2px;opacity:0;transition:opacity 0.15s;font-size:0.75rem;cursor:pointer;color:rgba(255,255,255,0.65);}
  .user-chip.active:hover .delete-user{opacity:1;}
  .user-chip:not(.active) .delete-user{color:var(--muted);}
  .user-chip:not(.active):hover .delete-user{opacity:1;}

  /* SUBJECT TAG PANEL */
  .subject-panel{max-width:600px;margin:0 auto 16px;background:var(--surface);border-radius:16px;padding:12px 16px;box-shadow:0 2px 12px var(--shadow);}
  .subject-panel-header{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
  .subject-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .subject-input{flex:1;min-width:160px;padding:7px 14px;border-radius:50px;border:1.5px solid var(--border);
    font-family:'Lato',sans-serif;font-size:0.85rem;background:var(--bg);color:var(--text);outline:none;transition:border-color 0.2s;}
  .subject-input:focus{border-color:var(--accent);}
  .subject-chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
  .subject-recent-chip{padding:4px 11px;border-radius:50px;border:1.5px solid var(--border);background:var(--bg);
    font-size:0.75rem;font-weight:700;color:var(--muted);cursor:pointer;transition:all 0.16s;white-space:nowrap;}
  .subject-recent-chip:hover{border-color:var(--accent);color:var(--accent);}
  .subject-recent-chip.selected{background:var(--accent);border-color:var(--accent);color:white;}

  /* MULTIPLIER */
  .multiplier-section{max-width:600px;margin:0 auto 20px;background:var(--surface);border-radius:16px;padding:14px 16px;box-shadow:0 2px 12px var(--shadow);}
  .multiplier-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .multiplier-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .multiplier-value-display{font-family:'Playfair Display',serif;font-size:1rem;color:var(--accent);font-weight:700;}
  .multiplier-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  .multiplier-presets{display:flex;gap:6px;flex-wrap:wrap;}
  .mult-chip{padding:5px 13px;border-radius:50px;border:1.5px solid var(--border);background:var(--bg);font-size:0.8rem;font-weight:700;color:var(--muted);cursor:pointer;transition:all 0.18s;}
  .mult-chip:hover{border-color:var(--accent);color:var(--accent);}
  .mult-chip.active{background:var(--accent);border-color:var(--accent);color:white;box-shadow:0 2px 8px rgba(193,127,90,0.3);}
  .multiplier-custom{display:flex;align-items:center;gap:6px;margin-left:auto;}
  .multiplier-custom label{font-size:0.78rem;color:var(--muted);white-space:nowrap;}
  .multiplier-custom input{width:62px;padding:5px 10px;border-radius:50px;border:1.5px solid var(--border);font-family:'Lato',sans-serif;font-size:0.88rem;background:var(--bg);color:var(--text);outline:none;text-align:center;transition:border-color 0.2s;}
  .multiplier-custom input:focus{border-color:var(--accent);}
  .multiplier-desc{margin-top:8px;font-size:0.78rem;color:var(--muted);}

  /* BREAK SETTINGS */
  .break-settings{max-width:600px;margin:0 auto 20px;background:var(--surface);border-radius:16px;padding:14px 16px;box-shadow:0 2px 12px var(--shadow);}
  .break-settings-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .break-settings-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .break-toggle-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
  .toggle-switch input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;inset:0;background:#d8cec6;border-radius:22px;cursor:pointer;transition:background 0.2s;}
  .toggle-slider:before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:white;border-radius:50%;transition:transform 0.2s;}
  .toggle-switch input:checked+.toggle-slider{background:var(--accent2);}
  .toggle-switch input:checked+.toggle-slider:before{transform:translateX(18px);}
  .toggle-label{font-size:0.82rem;color:var(--text);font-weight:700;}
  .break-options{margin-top:12px;display:none;gap:14px;flex-wrap:wrap;align-items:center;}
  .break-options.visible{display:flex;}
  .break-mode-chip{padding:5px 13px;border-radius:50px;border:1.5px solid var(--border);background:var(--bg);font-size:0.8rem;font-weight:700;color:var(--muted);cursor:pointer;transition:all 0.18s;}
  .break-mode-chip:hover{border-color:var(--accent2);color:var(--accent2);}
  .break-mode-chip.active{background:var(--accent2);border-color:var(--accent2);color:white;box-shadow:0 2px 8px rgba(122,158,135,0.3);}
  .break-custom-wrap{display:none;align-items:center;gap:6px;}
  .break-custom-wrap.visible{display:flex;}
  .break-custom-wrap label{font-size:0.78rem;color:var(--muted);white-space:nowrap;}
  .break-custom-wrap input{width:62px;padding:5px 10px;border-radius:50px;border:1.5px solid var(--border);font-family:'Lato',sans-serif;font-size:0.88rem;background:var(--bg);color:var(--text);outline:none;text-align:center;transition:border-color 0.2s;}
  .break-custom-wrap input:focus{border-color:var(--accent2);}
  .break-desc{font-size:0.78rem;color:var(--muted);margin-top:8px;}

  /* TIMER */
  .timer-section{background:var(--surface);border-radius:20px;padding:28px 24px 24px;text-align:center;box-shadow:0 4px 24px var(--shadow);max-width:480px;margin:0 auto 28px;}
  .current-user-banner{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:14px;font-weight:700;}
  .current-card-display{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:18px;}
  .drawn-card{width:64px;height:90px;border-radius:8px;background:var(--surface);border:2px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;box-shadow:0 2px 12px var(--shadow);transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);}
  .drawn-card.red{color:var(--red);}.drawn-card.black{color:var(--black);}
  .drawn-card.empty{color:var(--muted);font-size:0.8rem;font-family:'Lato',sans-serif;font-weight:300;background:var(--card-back);}
  .timer-display{font-family:'Playfair Display',serif;font-size:4.5rem;font-weight:700;letter-spacing:2px;color:var(--text);line-height:1;margin-bottom:8px;transition:color 0.3s;}
  .timer-display.running{color:var(--accent2);}
  .timer-display.break-running{color:var(--pomo-long);}
  .timer-label{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:20px;}
  .timer-controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .break-phase-banner{display:none;background:linear-gradient(135deg,var(--accent2),var(--pomo-long));color:white;border-radius:12px;padding:10px 16px;margin-bottom:16px;font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;text-align:center;}
  .break-phase-banner.visible{display:block;}

  /* BUTTONS */
  .btn{padding:10px 22px;border:none;border-radius:50px;font-family:'Lato',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
  .btn:active{transform:scale(0.96);}
  .btn-primary{background:var(--accent);color:white;box-shadow:0 3px 12px rgba(193,127,90,0.35);}
  .btn-primary:hover{background:#a86d48;}
  .btn-secondary{background:var(--accent2);color:white;box-shadow:0 3px 12px rgba(122,158,135,0.35);}
  .btn-secondary:hover{background:#6a8e75;}
  .btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border);}
  .btn-ghost:hover{background:var(--card-back);color:var(--text);}
  .btn-sm{padding:6px 14px;font-size:0.8rem;}
  .btn:disabled{background:var(--disabled);color:var(--disabled-text);cursor:not-allowed;box-shadow:none;}

  /* PROGRESS BAR */
  .progress-bar-wrap{height:6px;background:var(--card-back);border-radius:99px;margin:16px 0 0;overflow:hidden;}
  .progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:99px;width:100%;transition:width 1s linear;}
  .progress-bar-fill.break-fill{background:linear-gradient(90deg,var(--pomo-long),var(--accent2));}

  /* DECK */
  .deck-section{max-width:600px;margin:0 auto;}
  .deck-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:0 4px;}
  .deck-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--text);}
  .deck-count{font-size:0.85rem;color:var(--muted);background:var(--surface);padding:4px 12px;border-radius:99px;border:1px solid var(--border);}
  .suits-container{display:flex;flex-direction:column;gap:12px;padding-bottom:12px;}
  .suit-row{background:var(--surface);border-radius:14px;padding:14px 14px 10px;box-shadow:0 2px 12px var(--shadow);}
  .suit-label{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
  .suit-label .suit-icon{font-size:1rem;}
  .suit-label.red .suit-icon{color:var(--red);}.suit-label.black .suit-icon{color:var(--black);}
  .cards-grid{display:flex;flex-wrap:wrap;gap:6px;min-height:70px;}
  .mini-card{width:38px;height:54px;border-radius:6px;border:1.5px solid var(--border);background:var(--surface);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;user-select:none;}
  .mini-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow);}
  .mini-card.red{color:var(--red);}.mini-card.black{color:var(--black);}
  .mini-card.disabled{background:var(--card-back);color:var(--disabled-text);border-color:var(--disabled);text-decoration:line-through;opacity:0.5;transform:none;}
  .mini-card.cleared{background:var(--card-back);color:var(--disabled-text);border-color:var(--disabled);opacity:0.35;transform:none;border-style:dashed;}
  .mini-card .mini-suit{font-size:0.55rem;}
  .mini-card.active-card{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent),0 4px 14px rgba(193,127,90,0.3);}
  .reset-wrap{text-align:center;margin-top:16px;}

  /* ANIMATIONS */
  @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
  .pop{animation:pop 0.3s ease;}
  @keyframes pulse-red{0%,100%{color:var(--red)}50%{color:#e87070}}
  .timer-display.pulsing{animation:pulse-red 0.6s ease infinite;}
  @keyframes pulse-blue{0%,100%{color:var(--pomo-long)}50%{color:#8db5d4}}
  .timer-display.pulsing-break{animation:pulse-blue 0.6s ease infinite;}

  /* FOOTER */
  .site-footer{max-width:600px;margin:40px auto 0;padding:20px 16px;text-align:center;border-top:1px solid var(--border);}
  .site-footer p{font-size:0.78rem;color:var(--muted);letter-spacing:0.5px;}
  .site-footer a{color:var(--accent);text-decoration:none;font-weight:700;}
  .site-footer a:hover{opacity:0.75;}

  /* POMODORO */
  .pomo-container{max-width:480px;margin:0 auto;}
  .pomo-subject-bar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
  .pomo-subject-label{font-size:0.72rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);white-space:nowrap;}
  .pomo-subject-input{flex:1;min-width:150px;padding:7px 14px;border-radius:50px;border:1.5px solid var(--border);font-family:'Lato',sans-serif;font-size:0.85rem;background:var(--surface);color:var(--text);outline:none;transition:border-color 0.2s;}
  .pomo-subject-input:focus{border-color:var(--pomo-work);}
  .pomo-subject-chips{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px;}

  .pomo-mode-tabs{display:flex;background:var(--surface);border-radius:14px;padding:5px;box-shadow:0 2px 12px var(--shadow);margin-bottom:20px;}
  .pomo-mode-btn{flex:1;padding:9px 0;border:none;background:transparent;font-family:'Lato',sans-serif;font-size:0.82rem;font-weight:700;color:var(--muted);border-radius:10px;cursor:pointer;transition:all 0.22s;letter-spacing:0.3px;}
  .pomo-mode-btn.active{color:white;}
  .pomo-mode-btn.work.active{background:var(--pomo-work);box-shadow:0 2px 10px rgba(193,127,90,0.35);}
  .pomo-mode-btn.short.active{background:var(--pomo-short);box-shadow:0 2px 10px rgba(122,158,135,0.35);}
  .pomo-mode-btn.long.active{background:var(--pomo-long);box-shadow:0 2px 10px rgba(90,127,160,0.35);}
  .pomo-mode-btn:not(.active):hover{background:var(--card-back);color:var(--text);}
  .pomo-card{background:var(--surface);border-radius:20px;padding:28px 24px 24px;text-align:center;box-shadow:0 4px 24px var(--shadow);margin-bottom:20px;}
  .pomo-session-label{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;font-weight:700;}
  .pomo-session-label.work{color:var(--pomo-work);}.pomo-session-label.short{color:var(--pomo-short);}.pomo-session-label.long{color:var(--pomo-long);}
  .pomo-sublabel{font-size:0.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:18px;}
  .pomo-progress-ring{margin:0 auto 18px;position:relative;width:160px;height:160px;display:flex;align-items:center;justify-content:center;}
  .pomo-ring-svg{position:absolute;inset:0;transform:rotate(-90deg);}
  .pomo-ring-bg{fill:none;stroke:var(--card-back);stroke-width:7;}
  .pomo-ring-fill{fill:none;stroke-width:7;stroke-linecap:round;transition:stroke-dashoffset 1s linear,stroke 0.4s;}
  .pomo-ring-inner{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:var(--text);}
  .pomo-controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .btn-pomo-work{background:var(--pomo-work);color:white;box-shadow:0 3px 12px rgba(193,127,90,0.35);}
  .btn-pomo-work:hover{background:#a86d48;}
  .btn-pomo-short{background:var(--pomo-short);color:white;box-shadow:0 3px 12px rgba(122,158,135,0.35);}
  .btn-pomo-short:hover{background:#6a8e75;}
  .btn-pomo-long{background:var(--pomo-long);color:white;box-shadow:0 3px 12px rgba(90,127,160,0.3);}
  .btn-pomo-long:hover{background:#4a6f90;}
  .pomo-settings{background:var(--surface);border-radius:16px;padding:18px 18px 14px;box-shadow:0 2px 12px var(--shadow);margin-bottom:20px;}
  .pomo-settings-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:14px;}
  .pomo-settings-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;}
  .pomo-setting{display:flex;flex-direction:column;gap:5px;}
  .pomo-setting label{font-size:0.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
  .pomo-setting input{padding:7px 10px;border-radius:10px;border:1.5px solid var(--border);font-family:'Lato',sans-serif;font-size:0.9rem;background:var(--bg);color:var(--text);outline:none;text-align:center;width:100%;transition:border-color 0.2s;}
  .pomo-setting input:focus{border-color:var(--accent);}
  .pomo-setting .setting-unit{font-size:0.7rem;color:var(--muted);text-align:center;}

  /* POMO STATS PANEL */
  .pomo-stats{background:var(--surface);border-radius:16px;padding:16px 18px;box-shadow:0 2px 12px var(--shadow);}
  .pomo-stats-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .pomo-stats-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);}
  .stats-period-toggle{display:flex;background:var(--bg);border-radius:50px;padding:3px;gap:2px;}
  .period-btn{padding:3px 11px;border:none;border-radius:50px;font-family:'Lato',sans-serif;font-size:0.7rem;font-weight:700;color:var(--muted);background:transparent;cursor:pointer;transition:all 0.16s;}
  .period-btn.active{background:var(--accent);color:white;}
  .pomo-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
  .pomo-stat{text-align:center;padding:10px 6px;background:var(--bg);border-radius:12px;}
  .pomo-stat-num{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--accent);line-height:1;}
  .pomo-stat-lbl{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:3px;}
  .pomo-dots{display:flex;gap:6px;justify-content:center;margin-bottom:6px;}
  .pomo-dot{width:10px;height:10px;border-radius:50%;background:var(--border);transition:background 0.3s;}
  .pomo-dot.done{background:var(--pomo-work);}.pomo-dot.current{background:var(--pomo-short);}

  /* SESSION HISTORY (shared styles) */
  .history-section-title{font-size:0.72rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
  .history-list{display:flex;flex-direction:column;gap:5px;max-height:220px;overflow-y:auto;padding-right:2px;}
  .history-list::-webkit-scrollbar{width:3px;}
  .history-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}
  .history-item{display:flex;align-items:center;justify-content:space-between;padding:7px 11px;background:var(--bg);border-radius:10px;}
  .history-item-left{display:flex;flex-direction:column;gap:1px;}
  .history-item-subject{font-size:0.83rem;font-weight:700;color:var(--text);}
  .history-item-date{font-size:0.7rem;color:var(--muted);}
  .history-item-right{display:flex;align-items:center;gap:6px;}
  .history-item-mins{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;color:var(--accent);}
  .history-item-mins-lbl{font-size:0.65rem;color:var(--muted);}
  .history-tag{background:var(--accent);color:white;font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:99px;letter-spacing:0.5px;}
  .history-tag.green{background:var(--accent2);}
  .history-empty{font-size:0.8rem;color:var(--muted);text-align:center;padding:16px 0;font-style:italic;}

  /* MODALS */
  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(58,46,40,0.4);backdrop-filter:blur(3px);z-index:100;align-items:center;justify-content:center;padding:16px;}
  .modal-backdrop.visible{display:flex;}
  .modal{background:var(--surface);border-radius:20px;padding:28px 28px 24px;max-width:340px;width:100%;box-shadow:0 12px 40px rgba(58,46,40,0.25);animation:slideUp 0.2s ease;}
  .modal-lg{max-width:480px;}
  .modal-xl{max-width:560px;}
  @keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal h2{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:6px;}
  .modal > p{color:var(--muted);font-size:0.85rem;margin-bottom:18px;}
  .modal input[type=text]{width:100%;padding:10px 16px;border-radius:50px;border:1.5px solid var(--border);font-family:'Lato',sans-serif;font-size:0.95rem;background:var(--bg);color:var(--text);outline:none;margin-bottom:14px;transition:border-color 0.2s;}
  .modal input[type=text]:focus{border-color:var(--accent);}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;}
  .modal-scroll{max-height:70vh;overflow-y:auto;padding-right:6px;}
  .modal-scroll::-webkit-scrollbar{width:4px;}
  .modal-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

  /* TROPHY MODAL */
  .trophy-section{margin-bottom:20px;}
  .trophy-section-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--accent);margin-bottom:10px;}
  .trophy-kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:4px;}
  .trophy-kpi{text-align:center;padding:10px 6px;background:var(--bg);border-radius:12px;}
  .trophy-kpi-num{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--accent);line-height:1;}
  .trophy-kpi-lbl{font-size:0.67rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:3px;}

  /* DECK PROGRESS BAR */
  .deck-progress-outer{height:12px;background:var(--bg);border-radius:99px;overflow:hidden;display:flex;margin-bottom:6px;}
  .dp-bar-studied{background:var(--accent2);transition:width 0.5s;}
  .dp-bar-cleared{background:var(--disabled);transition:width 0.5s;}
  .dp-bar-remaining{flex:1;background:transparent;}
  .dp-legend{display:flex;gap:14px;flex-wrap:wrap;}
  .dp-legend-item{display:flex;align-items:center;gap:5px;font-size:0.71rem;color:var(--muted);}
  .dp-dot{width:8px;height:8px;border-radius:50%;}
  .modal-divider{border:none;border-top:1px solid var(--border);margin:16px 0;}

  /* HELP MODAL */
  .help-section{margin-bottom:16px;}
  .help-section h3{font-family:'Playfair Display',serif;font-size:0.98rem;color:var(--accent);margin-bottom:6px;}
  .help-section p,.help-section li{font-size:0.82rem;color:var(--muted);line-height:1.65;}
  .help-section ul{padding-left:16px;margin-top:4px;}
  .help-section li{margin-bottom:3px;}
  .help-divider{border:none;border-top:1px solid var(--border);margin:13px 0;}
  .help-badge{display:inline-block;color:white;font-size:0.62rem;font-weight:700;padding:2px 7px;border-radius:99px;text-transform:uppercase;letter-spacing:1px;margin-left:5px;vertical-align:middle;}
  .help-badge.orange{background:var(--accent);}
  .help-badge.green{background:var(--accent2);}
  .help-badge.blue{background:var(--pomo-long);}
</style>
</head>
<body>

<h1>Counting Cards</h1>
<p class="subtitle">Draw a card Â· Study for the Time Â· Get A's on Exams</p>

<!-- TROPHY BADGE (click â†’ progress modal) -->
<div class="deck-completions-badge" id="completionsBadge" title="Click to view your progress">
  <span class="badge-icon">ğŸ†</span>
  <div class="badge-content">
    <span class="badge-num" id="completionsCount">0</span>
    <span class="badge-label">Decks Done</span>
  </div>
</div>

<!-- STREAK BADGE -->
<div class="streak-badge" id="streakBadge" title="Study streak â€” complete at least 1 card per day to keep it going!">
  <span style="font-size:1rem">ğŸ”¥</span>
  <div class="badge-content">
    <span class="streak-num" id="streakCount">0</span>
    <span class="streak-sub">Day Streak</span>
  </div>
</div>

<!-- HELP -->
<button class="help-btn" id="helpBtn" title="How does this work?">?</button>

<!-- MAIN TABS -->
<div class="tabs-nav">
  <button class="tab-btn active" data-tab="deck">ğŸƒ Deck Study</button>
  <button class="tab-btn" data-tab="pomo">ğŸ… Pomodoro</button>
</div>

<!-- THEME -->
<div class="theme-switcher">
  <button class="theme-btn active" data-theme="warm"></button>
  <button class="theme-btn" data-theme="dark"></button>
  <button class="theme-btn" data-theme="midnight"></button>
  <button class="theme-btn" data-theme="forest"></button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DECK STUDY TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="tab-deck">

  <!-- USERS -->
  <div class="user-section">
    <div class="user-section-header">
      <span class="user-section-title">ğŸ‘¤ Studying Now</span>
      <button class="btn btn-ghost btn-sm" id="addUserBtn">+ Add User</button>
    </div>
    <div class="users-list" id="usersList"></div>
  </div>

  <!-- SUBJECT TAG â€” DECK -->
  <div class="subject-panel">
    <div class="subject-panel-header">ğŸ“š Subject / Topic</div>
    <div class="subject-row">
      <input class="subject-input" id="deckSubjectInput" placeholder="e.g. Organic Chemistry, Calculusâ€¦" maxlength="40">
    </div>
    <div class="subject-chips" id="deckSubjectChips"></div>
  </div>

  <!-- MULTIPLIER -->
  <div class="multiplier-section">
    <div class="multiplier-header">
      <span class="multiplier-title">â± Study Time per Card Value</span>
      <span class="multiplier-value-display" id="multValueDisplay">Ã—10 min</span>
    </div>
    <div class="multiplier-row">
      <div class="multiplier-presets" id="multPresets">
        <div class="mult-chip" data-mult="1">Ã—1</div>
        <div class="mult-chip" data-mult="5">Ã—5</div>
        <div class="mult-chip" data-mult="10">Ã—10</div>
        <div class="mult-chip" data-mult="15">Ã—15</div>
        <div class="mult-chip" data-mult="30">Ã—30</div>
      </div>
      <div class="multiplier-custom">
        <label for="multCustom">Custom:</label>
        <input type="number" id="multCustom" min="1" max="120" value="10" placeholder="10">
      </div>
    </div>
    <div class="multiplier-desc" id="multDesc">Ace=1min Â· 2â€“10=faceÃ—mult Â· J/Q/K=10Ã—mult Â· Joker=120min</div>
  </div>

  <!-- BREAK SETTINGS -->
  <div class="break-settings">
    <div class="break-settings-header">
      <span class="break-settings-title">â˜• Post-Card Break</span>
    </div>
    <div class="break-toggle-row">
      <label class="toggle-switch">
        <input type="checkbox" id="breakToggle">
        <span class="toggle-slider"></span>
      </label>
      <span class="toggle-label">Auto-break after each card</span>
    </div>
    <div class="break-options" id="breakOptions">
      <div class="break-mode-chip active" data-mode="half">Â½ Ã— card value Ã— Â½ multiplier</div>
      <div class="break-mode-chip" data-mode="custom">Custom</div>
      <div class="break-custom-wrap" id="breakCustomWrap">
        <label for="breakCustomMin">Minutes:</label>
        <input type="number" id="breakCustomMin" min="1" max="120" value="5" placeholder="5">
      </div>
    </div>
    <div class="break-desc" id="breakDesc" style="display:none;"></div>
  </div>

  <!-- TIMER -->
  <div class="timer-section">
    <div class="current-user-banner" id="currentUserBanner">â€” Select a user â€”</div>
    <div class="break-phase-banner" id="breakPhaseBanner">â˜• Break Time â€” You've earned it!</div>
    <div class="current-card-display">
      <div class="drawn-card empty" id="drawnCard"><span>draw</span><span>a card</span></div>
      <div>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div class="timer-label" id="timerLabel">Draw a card to start</div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar"></div></div>
      </div>
    </div>
    <div class="timer-controls">
      <button class="btn btn-primary" id="drawBtn">ğŸƒ Draw Card</button>
      <button class="btn btn-secondary" id="startStopBtn" disabled>â–¶ Start</button>
      <button class="btn btn-ghost" id="resetTimerBtn" disabled>â†º Reset</button>
      <button class="btn btn-ghost" id="clearCardBtn" disabled>âœ– Clear</button>
      <button class="btn btn-ghost" id="skipBreakBtn" style="display:none;">â­ Skip Break</button>
    </div>
  </div>

  <!-- CARD GRID -->
  <div class="deck-section">
    <div class="deck-header">
      <span class="deck-title">Your Deck</span>
      <span class="deck-count" id="deckCount">54 cards remaining</span>
    </div>
    <div class="suits-container" id="suitsContainer"></div>
    <div class="reset-wrap">
      <button class="btn btn-ghost" id="resetDeckBtn">Reset Full Deck</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• POMODORO TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-pomo">
  <div class="pomo-container">

    <!-- SUBJECT TAG â€” POMO -->
    <div class="subject-panel">
      <div class="subject-panel-header">ğŸ“š Subject / Topic</div>
      <div class="subject-row">
        <input class="subject-input" id="pomoSubjectInput" placeholder="e.g. Biology, Historyâ€¦" maxlength="40">
      </div>
      <div class="subject-chips" id="pomoSubjectChips"></div>
    </div>

    <div class="pomo-mode-tabs">
      <button class="pomo-mode-btn work active" data-mode="work">ğŸ… Work</button>
      <button class="pomo-mode-btn short" data-mode="short">â˜• Short Break</button>
      <button class="pomo-mode-btn long" data-mode="long">ğŸŒ¿ Long Break</button>
    </div>
    <div class="pomo-dots" id="pomoDots"></div>

    <div class="pomo-card">
      <div class="pomo-session-label work" id="pomoSessionLabel">Focus Time</div>
      <div class="pomo-progress-ring">
        <svg class="pomo-ring-svg" viewBox="0 0 160 160">
          <circle class="pomo-ring-bg" cx="80" cy="80" r="68"/>
          <circle class="pomo-ring-fill" id="pomoRingFill" cx="80" cy="80" r="68"
            stroke="var(--pomo-work)" stroke-dasharray="427.3" stroke-dashoffset="0"/>
        </svg>
        <div class="pomo-ring-inner" id="pomoTimerInner">25:00</div>
      </div>
      <div class="pomo-sublabel" id="pomoSubLabel">Ready to focus</div>
      <div class="pomo-controls">
        <button class="btn btn-pomo-work" id="pomoStartStopBtn">â–¶ Start</button>
        <button class="btn btn-ghost" id="pomoResetBtn">â†º Reset</button>
        <button class="btn btn-ghost btn-sm" id="pomoSkipBtn">â­ Skip</button>
      </div>
    </div>

    <div class="pomo-settings">
      <div class="pomo-settings-title">âš™ï¸ Session Durations</div>
      <div class="pomo-settings-grid">
        <div class="pomo-setting"><label>Work</label><input type="number" id="pomoWorkMin" value="25" min="1" max="120"><div class="setting-unit">minutes</div></div>
        <div class="pomo-setting"><label>Short Break</label><input type="number" id="pomoShortMin" value="5" min="1" max="60"><div class="setting-unit">minutes</div></div>
        <div class="pomo-setting"><label>Long Break</label><input type="number" id="pomoLongMin" value="15" min="1" max="120"><div class="setting-unit">minutes</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div class="pomo-setting" style="flex-direction:row;align-items:center;gap:8px;">
          <label style="text-transform:none;letter-spacing:0;font-size:0.82rem;color:var(--muted);">Long break after</label>
          <input type="number" id="pomoLongAfter" value="4" min="2" max="10" style="width:52px;">
          <label style="text-transform:none;letter-spacing:0;font-size:0.82rem;color:var(--muted);">sessions</label>
        </div>
        <button class="btn btn-ghost btn-sm" id="pomoApplyBtn">Apply</button>
      </div>
    </div>

    <!-- STATS: Today / All Time toggle + subject history -->
    <div class="pomo-stats">
      <div class="pomo-stats-header">
        <span class="pomo-stats-title">ğŸ“Š Stats</span>
        <div class="stats-period-toggle">
          <button class="period-btn active" id="statsTodayBtn">Today</button>
          <button class="period-btn" id="statsAllTimeBtn">All Time</button>
        </div>
      </div>
      <div class="pomo-stats-grid">
        <div class="pomo-stat"><div class="pomo-stat-num" id="statPomos">0</div><div class="pomo-stat-lbl">Pomodoros</div></div>
        <div class="pomo-stat"><div class="pomo-stat-num" id="statFocusMin">0</div><div class="pomo-stat-lbl">Focus min</div></div>
        <div class="pomo-stat"><div class="pomo-stat-num" id="statBreakMin">0</div><div class="pomo-stat-lbl">Break min</div></div>
      </div>
      <div class="history-section-title">What you studied</div>
      <div class="history-list" id="pomoHistoryList"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD USER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h2>Add a New User</h2>
    <p>Each user gets their own independent deck and progress.</p>
    <input type="text" id="newUserInput" placeholder="Enter nameâ€¦" maxlength="24"/>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" id="modalCancelBtn">Cancel</button>
      <button class="btn btn-primary btn-sm" id="modalConfirmBtn">Add User</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TROPHY / PROGRESS MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="trophyModalBackdrop">
  <div class="modal modal-xl">
    <h2>ğŸ† Your Progress</h2>
    <div class="modal-scroll">

      <!-- KPIs -->
      <div class="trophy-section">
        <div class="trophy-kpi-grid">
          <div class="trophy-kpi">
            <div class="trophy-kpi-num" id="trophyDecks">0</div>
            <div class="trophy-kpi-lbl">Decks Done</div>
          </div>
          <div class="trophy-kpi">
            <div class="trophy-kpi-num" id="trophyCards">0</div>
            <div class="trophy-kpi-lbl">Cards Studied</div>
          </div>
          <div class="trophy-kpi">
            <div class="trophy-kpi-num" id="trophyStreak">0 ğŸ”¥</div>
            <div class="trophy-kpi-lbl">Day Streak</div>
          </div>
        </div>
      </div>

      <hr class="modal-divider">

      <!-- DECK PROGRESS BAR -->
      <div class="trophy-section">
        <div class="trophy-section-title">Current Deck Progress</div>
        <div style="display:flex;justify-content:space-between;font-size:0.74rem;color:var(--muted);margin-bottom:6px;">
          <span id="dpLabel1">0 studied</span>
          <span id="dpLabel2">54 remaining</span>
        </div>
        <div class="deck-progress-outer">
          <div class="dp-bar-studied" id="dpStudied" style="width:0%"></div>
          <div class="dp-bar-cleared" id="dpCleared" style="width:0%"></div>
          <div class="dp-bar-remaining"></div>
        </div>
        <div class="dp-legend" style="margin-top:6px;">
          <div class="dp-legend-item"><div class="dp-dot" style="background:var(--accent2)"></div>Studied</div>
          <div class="dp-legend-item"><div class="dp-dot" style="background:var(--disabled)"></div>Cleared / Skipped</div>
          <div class="dp-legend-item"><div class="dp-dot" style="background:var(--border)"></div>Remaining</div>
        </div>
      </div>

      <hr class="modal-divider">

      <!-- DECK SESSION HISTORY -->
      <div class="trophy-section">
        <div class="trophy-section-title">Session History</div>
        <div class="history-list" id="deckHistoryList"></div>
      </div>

    </div>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-primary btn-sm" id="trophyCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELP MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="helpModalBackdrop">
  <div class="modal modal-lg">
    <h2>How Counting Cards Works</h2>
    <div class="modal-scroll">

      <div class="help-section">
        <h3>ğŸ§  The Core Concept</h3>
        <p>Counting Cards turns a standard 54-card deck into a structured study system. Each card represents a focused study block. Draw a card, study for that duration, then draw the next. The randomness keeps sessions varied and stops you grinding the same topic for hours.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸƒ Card Values &amp; Time</h3>
        <p>Time = card value Ã— multiplier. At the default Ã—10: Ace = 10 min, 2â€“10 = face Ã— 10, J/Q/K = 100 min, Joker = 120 min always. Adjust the multiplier to fit your schedule.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸ“š Subject Tagging <span class="help-badge orange">New</span></h3>
        <p>Type a subject before you start studying â€” Chemistry, Calculus, whatever you're working on. When your timer completes, that session is automatically saved to your history with the subject and duration. Your six most recent subjects appear as quick-tap chips so you don't have to retype them. You can see your full deck history in the ğŸ† trophy panel, and your Pomodoro history in the stats section of the Pomodoro tab.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸ”¥ Study Streak <span class="help-badge green">New</span></h3>
        <p>Complete at least one card per day (timer runs to zero naturally â€” clearing doesn't count) and your streak grows. Miss a day and it resets. Your streak lives under the trophy badge in the top-left corner.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸ† Progress Panel <span class="help-badge green">New</span></h3>
        <p>Click the trophy badge to open a detailed view: deck completions, total cards studied, your streak, a live colour-coded progress bar for the current deck, and your full session history.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>â˜• Post-Card Breaks</h3>
        <p>Toggle on an automatic break after each card. Default = Â½ card value Ã— Â½ multiplier (proportional to how long you just studied). Or set a fixed custom duration. The break timer is blue so you always know which phase you're in.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸ”” Notifications <span class="help-badge blue">New</span></h3>
        <p>The app asks for notification permission on first load. When a timer finishes â€” even if you've switched tabs or minimised the window â€” you'll get a desktop notification so you never miss it.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>â± Background Timers</h3>
        <p>All timers use real wall-clock time internally. Minimising or switching tabs never loses a single second.</p>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>âœ– Clear vs â†º Reset</h3>
        <ul>
          <li><strong>Reset</strong> â€” restarts the timer for the current card. Card stays marked as studied.</li>
          <li><strong>Clear</strong> â€” removes the card from the active slot and marks it as skipped (dashed border). Skipped cards don't count toward deck completion or the streak.</li>
        </ul>
      </div>
      <hr class="help-divider">

      <div class="help-section">
        <h3>ğŸ’¡ Why It Works</h3>
        <ul>
          <li><strong>Randomness fights monotony</strong> â€” unpredictable session lengths keep engagement high.</li>
          <li><strong>Variable durations mirror spaced repetition</strong> â€” short and long blocks naturally mix.</li>
          <li><strong>Completion tracking builds momentum</strong> â€” finishing a full deck is a real milestone.</li>
          <li><strong>Proportional breaks prevent burnout</strong> â€” the longer the session, the longer the reward.</li>
        </ul>
      </div>

    </div>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-primary btn-sm" id="helpCloseBtn">Got it!</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestNotifPerm() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}
function notify(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    try {
      new Notification(title, {
        body,
        icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â™ </text></svg>"
      });
    } catch(e) {}
  }
}
requestNotifPerm();

// â”€â”€ Background-safe ticker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeTicker(onTick, onComplete) {
  let startTime = null, pausedRemaining = null, totalSecs = 0, rafId = null, running = false;
  function tick() {
    if (!running) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const remaining = Math.max(0, pausedRemaining - elapsed);
    onTick(remaining, totalSecs);
    if (remaining <= 0) { running = false; onComplete(); return; }
    rafId = setTimeout(tick, 500);
  }
  return {
    start(secs)  { totalSecs = secs; pausedRemaining = secs; startTime = Date.now(); running = true; clearTimeout(rafId); tick(); },
    resume()     { if (running || pausedRemaining === null) return; startTime = Date.now(); running = true; clearTimeout(rafId); tick(); },
    pause()      { if (!running) return; pausedRemaining = Math.max(0, pausedRemaining - Math.floor((Date.now()-startTime)/1000)); running = false; clearTimeout(rafId); onTick(pausedRemaining, totalSecs); },
    stop()       { running = false; clearTimeout(rafId); pausedRemaining = null; startTime = null; },
    reset(secs)  { running = false; clearTimeout(rafId); totalSecs = secs; pausedRemaining = secs; startTime = null; onTick(secs, secs); },
    isRunning()  { return running; },
    remaining()  { if (!running) return pausedRemaining || 0; return Math.max(0, pausedRemaining - Math.floor((Date.now()-startTime)/1000)); }
  };
}

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUITS  = [{name:'Hearts',symbol:'â™¥',color:'red'},{name:'Diamonds',symbol:'â™¦',color:'red'},{name:'Clubs',symbol:'â™£',color:'black'},{name:'Spades',symbol:'â™ ',color:'black'}];
const RANKS  = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const JOKERS = ['Joker-Red','Joker-Black'];
const TOTAL  = SUITS.length * RANKS.length + JOKERS.length; // 54

function cardValue(rank) { if (rank==='A') return 1; if (['J','Q','K'].includes(rank)) return 10; return parseInt(rank); }
let multiplier = 10;
function studyMinutes(rank) { return rank === 'Joker' ? 120 : cardValue(rank) * multiplier; }
function isJoker(key) { return key === 'Joker-Red' || key === 'Joker-Black'; }

// Break state
let breakEnabled = false, breakMode = 'half', breakCustomMin = 5, isOnBreak = false;
function breakMinutesForCard(rank) {
  if (breakMode === 'custom') return breakCustomMin;
  if (rank === 'Joker') return 30;
  return Math.max(1, Math.round(0.5 * cardValue(rank) * multiplier * 0.5));
}

// â”€â”€ Storage keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const K_USERS      = 'studyDeck_users';
const K_ACTIVE     = 'studyDeck_activeUser';
const K_MULT       = 'studyDeck_multiplier';
const K_BREAK      = 'studyDeck_break';
const K_THEME      = 'studyDeck_theme';
const K_STREAK     = 'studyDeck_streak';
const K_SUBJECTS   = 'studyDeck_recentSubjects';  // shared recent list
const K_DECK_HIST  = 'studyDeck_deckHistory';
const K_POMO_TODAY = 'studyDeck_pomoToday';
const K_POMO_ALL   = 'studyDeck_pomoAllTime';
const K_POMO_HIST  = 'studyDeck_pomoHistory';

function ls_get(k)    { try { return JSON.parse(localStorage.getItem(k)); } catch(e) { return null; } }
function ls_set(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }

function getStoredMeta()         { return ls_get(K_USERS)  || []; }
function saveStoredMeta(m)       { ls_set(K_USERS, m); }
function getStoredUser(id)       { return ls_get('studyDeck_u_' + id); }
function saveStoredUser(id, d)   { ls_set('studyDeck_u_' + id, d); }
function deleteStoredUser(id)    { try { localStorage.removeItem('studyDeck_u_' + id); } catch(e) {} }
function getActiveId()           { return localStorage.getItem(K_ACTIVE) || null; }
function setActiveId(id)         { if (id) localStorage.setItem(K_ACTIVE, id); else localStorage.removeItem(K_ACTIVE); }

function freshDeck() {
  const d = {};
  SUITS.forEach(s => RANKS.forEach(r => { d[r + '-' + s.name] = true; }));
  JOKERS.forEach(j => { d[j] = true; });
  return d;
}
function countStudied(d) { return Object.values(d).filter(v => v === false).length; }
function countCleared(d) { return Object.values(d).filter(v => v === 'cleared').length; }
function isDeckComplete(d) { return countStudied(d) === TOTAL; }

// â”€â”€ Streak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStreak() { return ls_get(K_STREAK) || { count: 0, lastDate: '', lastTs: 0 }; }
function checkStreakExpiry() {
  // Called on page load â€” resets streak if more than 24h have passed since last activity.
  const s = getStreak();
  if (!s.lastTs && !s.lastDate) return; // never set, nothing to expire
  const today = new Date().toDateString();
  if (s.lastDate !== today && (Date.now() - (s.lastTs || 0)) > 86400000) {
    s.count = 0;
    ls_set(K_STREAK, s);
  }
}
function touchStreak() {
  const today = new Date().toDateString();
  const s = getStreak();
  if (s.lastDate === today) {
    // Already credited today â€” just refresh the timestamp so 24h window resets
    s.lastTs = Date.now();
    ls_set(K_STREAK, s);
    return;
  }
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  s.count = (s.lastDate === yesterday) ? s.count + 1 : 1;
  s.lastDate = today;
  s.lastTs = Date.now();
  ls_set(K_STREAK, s);
  renderStreakBadge();
}
function renderStreakBadge() {
  document.getElementById('streakCount').textContent = getStreak().count;
}

// â”€â”€ Recent subjects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRecentSubjects() { return ls_get(K_SUBJECTS) || []; }
function addRecentSubject(subj) {
  if (!subj || !subj.trim()) return;
  subj = subj.trim();
  let list = getRecentSubjects().filter(s => s !== subj);
  list.unshift(subj);
  ls_set(K_SUBJECTS, list.slice(0, 6));
  renderSubjectChips();
}
function renderSubjectChips() {
  const list = getRecentSubjects();
  // Deck chips
  renderChipsInto('deckSubjectChips', list, 'deckSubjectInput');
  // Pomo chips
  renderChipsInto('pomoSubjectChips', list, 'pomoSubjectInput');
}
function renderChipsInto(containerId, subjects, inputId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  subjects.forEach(subj => {
    const chip = document.createElement('span');
    chip.className = 'subject-recent-chip';
    chip.textContent = subj;
    chip.addEventListener('click', () => {
      const inp = document.getElementById(inputId);
      if (inp) { inp.value = subj; }
      container.querySelectorAll('.subject-recent-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
    });
    container.appendChild(chip);
  });
}

// â”€â”€ Deck history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDeckHistory() { return ls_get(K_DECK_HIST) || []; }
function logDeckSession(subj, mins) {
  if (!subj || !subj.trim()) return;
  const list = getDeckHistory();
  list.unshift({ subject: subj.trim(), mins, date: new Date().toLocaleDateString(), ts: Date.now() });
  ls_set(K_DECK_HIST, list.slice(0, 60));
}

// â”€â”€ Pomo stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pomoStatsToday   = { pomos: 0, focusMin: 0, breakMin: 0 };
let pomoStatsAllTime = { pomos: 0, focusMin: 0, breakMin: 0 };
let statsPeriod = 'today'; // 'today' | 'alltime'

function loadPomoStats() {
  const saved = ls_get(K_POMO_TODAY);
  if (saved && saved.date === new Date().toDateString()) {
    pomoStatsToday = saved.stats;
  } else {
    pomoStatsToday = { pomos: 0, focusMin: 0, breakMin: 0 };
    ls_set(K_POMO_TODAY, { date: new Date().toDateString(), stats: pomoStatsToday });
  }
  pomoStatsAllTime = ls_get(K_POMO_ALL) || { pomos: 0, focusMin: 0, breakMin: 0 };
}
function savePomoStats() {
  ls_set(K_POMO_TODAY, { date: new Date().toDateString(), stats: pomoStatsToday });
  ls_set(K_POMO_ALL,   pomoStatsAllTime);
}
function renderPomoStats() {
  const d = statsPeriod === 'today' ? pomoStatsToday : pomoStatsAllTime;
  document.getElementById('statPomos').textContent    = d.pomos;
  document.getElementById('statFocusMin').textContent = d.focusMin;
  document.getElementById('statBreakMin').textContent = d.breakMin;
}

// â”€â”€ Pomo history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPomoHistory() { return ls_get(K_POMO_HIST) || []; }
function logPomoSession(subj, mins) {
  if (!subj || !subj.trim()) return;
  const list = getPomoHistory();
  list.unshift({ subject: subj.trim(), mins, date: new Date().toLocaleDateString(), ts: Date.now() });
  ls_set(K_POMO_HIST, list.slice(0, 60));
  renderPomoHistory();
}
function renderPomoHistory() {
  const container = document.getElementById('pomoHistoryList');
  const list = getPomoHistory();
  renderHistoryList(container, list, 'green');
}

// Shared history renderer
function renderHistoryList(container, list, tagClass) {
  container.innerHTML = '';
  if (!list.length) {
    container.innerHTML = '<div class="history-empty">No sessions yet. Set a subject and let the timer complete!</div>';
    return;
  }
  list.slice(0, 20).forEach(item => {
    const el = document.createElement('div');
    el.className = 'history-item';
    el.innerHTML = `
      <div class="history-item-left">
        <span class="history-item-subject">${escHtml(item.subject)}</span>
        <span class="history-item-date">${item.date}</span>
      </div>
      <div class="history-item-right">
        <span class="history-item-mins">${item.mins}</span>
        <span class="history-item-mins-lbl">min</span>
        <span class="history-tag ${tagClass || ''}">ğŸ“š</span>
      </div>`;
    container.appendChild(el);
  });
}
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€ User management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let users = [], activeUserId = null, deck = {}, currentCard = null;

function getActiveUser() { return users.find(u => u.id === activeUserId) || null; }
function persist() {
  const u = getActiveUser();
  if (!u) return;
  u.deck = deck; u.currentCard = currentCard;
  saveStoredUser(u.id, u);
}
function createUser(name) {
  const id = 'u' + Date.now() + Math.random().toString(36).slice(2,5);
  return { id, name, deck: freshDeck(), currentCard: null, deckCompletions: 0 };
}
function addUser(name) {
  name = name.trim(); if (!name) return;
  const u = createUser(name); users.push(u);
  saveStoredMeta(users.map(u => ({ id: u.id, name: u.name })));
  saveStoredUser(u.id, u); switchUser(u.id);
}
function removeUser(id) {
  if (users.length <= 1) { alert('You need at least one user.'); return; }
  const u = users.find(u => u.id === id);
  if (!confirm('Remove ' + (u ? u.name : 'this user') + '? Their progress will be lost.')) return;
  deleteStoredUser(id); users = users.filter(u => u.id !== id);
  saveStoredMeta(users.map(u => ({ id: u.id, name: u.name })));
  if (activeUserId === id) switchUser(users[0].id); else renderUsers();
}
function switchUser(id) {
  persist();
  deckTicker.stop(); breakTicker.stop(); isOnBreak = false;
  document.getElementById('breakPhaseBanner').classList.remove('visible');
  document.getElementById('progressBar').classList.remove('break-fill');
  document.getElementById('skipBreakBtn').style.display = 'none';
  activeUserId = id; setActiveId(id);
  const u = users.find(u => u.id === id); if (!u) return;
  deck = u.deck || freshDeck(); currentCard = u.currentCard || null;
  document.getElementById('currentUserBanner').textContent = 'ğŸ“– ' + u.name + '\'s Session';
  updateCompletionsBadge(); restoreCardDisplay(); renderUsers(); renderDeck();
}
function initials(name) { return name.trim().split(/\s+/).map(w => w[0]).join('').toUpperCase().slice(0, 2); }

// â”€â”€ Completions badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCompletionsBadge() {
  const u = getActiveUser();
  document.getElementById('completionsCount').textContent = u ? (u.deckCompletions || 0) : 0;
}
function animateBadge() {
  const b = document.getElementById('completionsBadge');
  b.classList.remove('badge-animate'); void b.offsetWidth; b.classList.add('badge-animate');
}
function checkDeckCompletion() {
  if (!isDeckComplete(deck)) return;
  const u = getActiveUser(); if (!u) return;
  u.deckCompletions = (u.deckCompletions || 0) + 1;
  saveStoredUser(u.id, u); updateCompletionsBadge(); animateBadge();
  notify('ğŸ‰ Deck Complete!', 'You finished all 54 cards. Incredible work!');
  showToast('ğŸ‰ Deck Complete! (' + u.deckCompletions + (u.deckCompletions === 1 ? ' time' : ' times') + ')');
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const ex = document.getElementById('studyToast'); if (ex) ex.remove();
  ensurePopupStyle();
  const t = document.createElement('div'); t.id = 'studyToast';
  t.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:#2a2420;color:#fff;padding:14px 24px;border-radius:50px;font-family:Lato,sans-serif;font-size:0.9rem;font-weight:700;box-shadow:0 8px 32px rgba(0,0,0,0.35);z-index:9998;white-space:nowrap;animation:slideUpPopup .3s ease;';
  t.textContent = msg; document.body.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, 4000);
}
function ensurePopupStyle() {
  if (document.getElementById('popupStyle')) return;
  const s = document.createElement('style'); s.id = 'popupStyle';
  s.textContent = '@keyframes slideUpPopup{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}';
  document.head.appendChild(s);
}

function renderUsers() {
  const list = document.getElementById('usersList'); list.innerHTML = '';
  users.forEach(u => {
    const chip = document.createElement('div');
    chip.className = 'user-chip' + (u.id === activeUserId ? ' active' : '');
    const av = document.createElement('span'); av.className = 'user-avatar'; av.textContent = initials(u.name);
    const lbl = document.createElement('span'); lbl.textContent = u.name;
    const del = document.createElement('span'); del.className = 'delete-user'; del.title = 'Remove'; del.textContent = 'âœ•';
    del.addEventListener('click', e => { e.stopPropagation(); removeUser(u.id); });
    chip.appendChild(av); chip.appendChild(lbl); chip.appendChild(del);
    chip.addEventListener('click', () => { if (u.id !== activeUserId) switchUser(u.id); });
    list.appendChild(chip);
  });
}

function cardLabel(c) {
  if (!c) return '';
  return isJoker(c.key) ? c.suit.name + ' Joker' : c.rank + ' of ' + c.suit.name;
}

function formatTime(secs) {
  return String(Math.floor(secs / 60)).padStart(2, '0') + ':' + String(secs % 60).padStart(2, '0');
}

function restoreCardDisplay() {
  const el = document.getElementById('drawnCard'); deckTicker.stop();
  if (currentCard) {
    const joker = isJoker(currentCard.key);
    el.className = 'drawn-card ' + currentCard.suit.color;
    el.innerHTML = '<span>' + (joker ? 'ğŸƒ' : currentCard.rank) + '</span><span class="mini-suit">' + (joker ? currentCard.suit.name : currentCard.suit.symbol) + '</span>';
    const mins = studyMinutes(currentCard.rank), secs = mins * 60;
    deckTicker.reset(secs);
    document.getElementById('timerDisplay').textContent = formatTime(secs);
    document.getElementById('timerDisplay').className = 'timer-display';
    document.getElementById('timerLabel').textContent = cardLabel(currentCard) + ' Â· ' + mins + ' minutes';
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('startStopBtn').disabled = false; document.getElementById('startStopBtn').textContent = 'â–¶ Start';
    document.getElementById('resetTimerBtn').disabled = false; document.getElementById('clearCardBtn').disabled = false;
  } else {
    el.className = 'drawn-card empty'; el.innerHTML = '<span>draw</span><span>a card</span>';
    deckTicker.reset(0);
    document.getElementById('timerDisplay').textContent = '00:00';
    document.getElementById('timerDisplay').className = 'timer-display';
    document.getElementById('timerLabel').textContent = 'Draw a card to start';
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('startStopBtn').disabled = true; document.getElementById('startStopBtn').textContent = 'â–¶ Start';
    document.getElementById('resetTimerBtn').disabled = true; document.getElementById('clearCardBtn').disabled = true;
  }
}

// â”€â”€ Deck render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function availableCards() { return Object.keys(deck).filter(k => deck[k] === true); }
function updateDeckCount() {
  const n = availableCards().length;
  document.getElementById('deckCount').textContent = n + ' card' + (n !== 1 ? 's' : '') + ' remaining';
}
function renderDeck() {
  const container = document.getElementById('suitsContainer'); container.innerHTML = '';
  SUITS.forEach(suit => {
    const row = document.createElement('div'); row.className = 'suit-row';
    const label = document.createElement('div'); label.className = 'suit-label ' + suit.color;
    label.innerHTML = '<span class="suit-icon">' + suit.symbol + '</span> ' + suit.name;
    row.appendChild(label);
    const grid = document.createElement('div'); grid.className = 'cards-grid';
    RANKS.forEach(rank => {
      const key = rank + '-' + suit.name, val = deck[key];
      const card = document.createElement('div');
      let cls = 'mini-card ' + suit.color;
      if (val === false) cls += ' disabled'; else if (val === 'cleared') cls += ' cleared';
      if (currentCard && currentCard.key === key) cls += ' active-card';
      card.className = cls;
      card.innerHTML = '<span>' + rank + '</span><span class="mini-suit">' + suit.symbol + '</span>';
      card.title = rank + ' of ' + suit.name + ' â€” ' + studyMinutes(rank) + 'min' + (val === 'cleared' ? ' (cleared)' : '');
      card.addEventListener('click', () => toggleCard(key));
      grid.appendChild(card);
    });
    row.appendChild(grid); container.appendChild(row);
  });
  // Jokers
  const jr = document.createElement('div'); jr.className = 'suit-row';
  const jl = document.createElement('div'); jl.className = 'suit-label black';
  jl.innerHTML = '<span class="suit-icon">ğŸƒ</span> Jokers <span style="margin-left:6px;font-size:0.7rem;color:var(--accent)">(120 min each)</span>';
  jr.appendChild(jl);
  const jg = document.createElement('div'); jg.className = 'cards-grid';
  JOKERS.forEach(key => {
    const isRed = key === 'Joker-Red', val = deck[key];
    const card = document.createElement('div');
    let cls = 'mini-card ' + (isRed ? 'red' : 'black');
    if (val === false) cls += ' disabled'; else if (val === 'cleared') cls += ' cleared';
    if (currentCard && currentCard.key === key) cls += ' active-card';
    card.className = cls;
    card.innerHTML = '<span>ğŸƒ</span><span class="mini-suit" style="font-size:0.6rem">' + (isRed ? 'Red' : 'Blk') + '</span>';
    card.title = (isRed ? 'Red' : 'Black') + ' Joker â€” 120min' + (val === 'cleared' ? ' (cleared)' : '');
    card.addEventListener('click', () => toggleCard(key));
    jg.appendChild(card);
  });
  jr.appendChild(jg); container.appendChild(jr);
  updateDeckCount();
}

function toggleCard(key) {
  if (currentCard && currentCard.key === key) return;
  if (deck[key] === true) deck[key] = false;
  else if (deck[key] === false) deck[key] = true;
  else if (deck[key] === 'cleared') deck[key] = true;
  persist(); checkDeckCompletion(); renderDeck();
}

// â”€â”€ Draw & timers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCard() {
  if (!activeUserId) { alert('Please select or add a user first!'); return; }
  if (isOnBreak) { alert('Finish your break first! (or click Skip Break)'); return; }
  const avail = availableCards();
  if (!avail.length) { alert('No cards left! Reset the deck to play again.'); return; }
  deckTicker.stop();
  const key = avail[Math.floor(Math.random() * avail.length)];
  deck[key] = false;
  let rank, suit;
  if (isJoker(key)) {
    rank = 'Joker';
    const isRed = key === 'Joker-Red';
    suit = { name: isRed ? 'Red' : 'Black', symbol: 'ğŸƒ', color: isRed ? 'red' : 'black' };
  } else {
    const parts = key.split('-'); rank = parts[0];
    suit = SUITS.find(s => s.name === parts.slice(1).join('-'));
  }
  currentCard = { key, rank, suit };
  const el = document.getElementById('drawnCard');
  el.className = 'drawn-card ' + suit.color;
  el.innerHTML = '<span>' + (rank === 'Joker' ? 'ğŸƒ' : rank) + '</span><span class="mini-suit">' + (rank === 'Joker' ? suit.name : suit.symbol) + '</span>';
  el.classList.add('pop'); setTimeout(() => el.classList.remove('pop'), 400);
  const mins = studyMinutes(rank), secs = mins * 60;
  deckTicker.reset(secs);
  document.getElementById('timerDisplay').textContent = formatTime(secs);
  document.getElementById('timerDisplay').className = 'timer-display';
  document.getElementById('timerLabel').textContent = cardLabel(currentCard) + ' Â· ' + mins + ' minutes';
  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('progressBar').classList.remove('break-fill');
  document.getElementById('startStopBtn').disabled = false; document.getElementById('startStopBtn').textContent = 'â–¶ Start';
  document.getElementById('resetTimerBtn').disabled = false; document.getElementById('clearCardBtn').disabled = false;
  persist(); checkDeckCompletion(); renderDeck();
}

const deckTicker = makeTicker(
  function(remaining, total) {
    if (isOnBreak) return;
    document.getElementById('timerDisplay').textContent = formatTime(remaining);
    document.getElementById('progressBar').style.width = (remaining / total * 100) + '%';
  },
  function() {
    if (isOnBreak) return;
    document.getElementById('timerDisplay').className = 'timer-display pulsing';
    document.getElementById('timerLabel').textContent = "âœ… Time's up! Great work!";
    document.getElementById('startStopBtn').textContent = 'â–¶ Start';
    document.getElementById('startStopBtn').disabled = true;
    document.getElementById('progressBar').style.width = '0%';
    // Log session & streak
    const subj = document.getElementById('deckSubjectInput').value.trim();
    if (subj && currentCard) {
      logDeckSession(subj, studyMinutes(currentCard.rank));
      addRecentSubject(subj);
    }
    touchStreak();
    notify('â° Time\'s up!', (subj ? subj + ' â€” ' : '') + cardLabel(currentCard) + ' complete!');
    playAlarm();
    if (breakEnabled && currentCard) {
      setTimeout(() => startBreakPhase(currentCard), 1200);
    }
  }
);

const breakTicker = makeTicker(
  function(remaining, total) {
    document.getElementById('timerDisplay').textContent = formatTime(remaining);
    document.getElementById('progressBar').style.width = (remaining / total * 100) + '%';
  },
  function() {
    endBreakPhase();
    notify('â˜• Break over!', 'Time to get back to studying.');
    playAlarm();
  }
);

function startBreakPhase(card) {
  isOnBreak = true;
  const mins = breakMinutesForCard(card.rank), secs = mins * 60;
  document.getElementById('breakPhaseBanner').classList.add('visible');
  document.getElementById('timerDisplay').className = 'timer-display break-running';
  document.getElementById('timerLabel').textContent = 'â˜• Break Â· ' + mins + ' min â€” relax!';
  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('progressBar').classList.add('break-fill');
  document.getElementById('startStopBtn').disabled = true;
  document.getElementById('resetTimerBtn').disabled = true;
  document.getElementById('clearCardBtn').disabled = true;
  document.getElementById('skipBreakBtn').style.display = '';
  breakTicker.start(secs);
}
function endBreakPhase() {
  isOnBreak = false; breakTicker.stop();
  document.getElementById('breakPhaseBanner').classList.remove('visible');
  document.getElementById('timerDisplay').className = 'timer-display';
  document.getElementById('timerLabel').textContent = 'Draw a card to start';
  document.getElementById('timerDisplay').textContent = '00:00';
  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('progressBar').classList.remove('break-fill');
  document.getElementById('skipBreakBtn').style.display = 'none';
  document.getElementById('startStopBtn').disabled = true;
  document.getElementById('resetTimerBtn').disabled = true;
  document.getElementById('clearCardBtn').disabled = true;
}

function startTimer() {
  if (isOnBreak || deckTicker.isRunning()) return;
  document.getElementById('startStopBtn').textContent = 'â¸ Pause';
  document.getElementById('timerDisplay').className = 'timer-display running';
  if (deckTicker.remaining() > 0) deckTicker.resume();
}
function pauseTimer() {
  deckTicker.pause();
  document.getElementById('startStopBtn').textContent = 'â–¶ Start';
  document.getElementById('timerDisplay').className = 'timer-display';
}
function resetTimer() {
  if (isOnBreak) return;
  deckTicker.stop();
  if (currentCard) {
    const mins = studyMinutes(currentCard.rank), secs = mins * 60;
    deckTicker.reset(secs);
    document.getElementById('timerDisplay').textContent = formatTime(secs);
    document.getElementById('timerDisplay').className = 'timer-display';
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('startStopBtn').textContent = 'â–¶ Start';
    document.getElementById('startStopBtn').disabled = false;
  }
}
function clearCard() {
  if (!currentCard) return;
  deckTicker.stop(); breakTicker.stop(); isOnBreak = false;
  deck[currentCard.key] = 'cleared'; currentCard = null;
  const el = document.getElementById('drawnCard');
  el.className = 'drawn-card empty'; el.innerHTML = '<span>draw</span><span>a card</span>';
  document.getElementById('breakPhaseBanner').classList.remove('visible');
  document.getElementById('progressBar').classList.remove('break-fill');
  document.getElementById('timerDisplay').textContent = '00:00';
  document.getElementById('timerDisplay').className = 'timer-display';
  document.getElementById('timerLabel').textContent = 'Draw a card to start';
  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('startStopBtn').disabled = true; document.getElementById('startStopBtn').textContent = 'â–¶ Start';
  document.getElementById('resetTimerBtn').disabled = true; document.getElementById('clearCardBtn').disabled = true;
  document.getElementById('skipBreakBtn').style.display = 'none';
  persist(); renderDeck();
}

// â”€â”€ Multiplier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMultiplier(val) {
  val = Math.max(1, Math.min(120, parseInt(val) || 10)); multiplier = val;
  ls_set(K_MULT, val);
  document.getElementById('multValueDisplay').textContent = 'Ã—' + val + ' min';
  document.getElementById('multCustom').value = val;
  document.getElementById('multDesc').textContent = 'Ace=' + val + 'min Â· 2â€“10=faceÃ—' + val + ' Â· J/Q/K=' + (10*val) + 'min Â· Joker=120min';
  document.querySelectorAll('.mult-chip').forEach(c => c.classList.toggle('active', parseInt(c.dataset.mult) === val));
  updateBreakDesc();
  if (currentCard && !isOnBreak) {
    const mins = studyMinutes(currentCard.rank), secs = mins * 60;
    deckTicker.reset(secs);
    document.getElementById('timerLabel').textContent = cardLabel(currentCard) + ' Â· ' + mins + ' minutes';
    document.getElementById('startStopBtn').textContent = 'â–¶ Start';
    document.getElementById('startStopBtn').disabled = false;
  }
  renderDeck();
}
document.querySelectorAll('.mult-chip').forEach(c => c.addEventListener('click', () => setMultiplier(parseInt(c.dataset.mult))));
document.getElementById('multCustom').addEventListener('input', function() { const v = parseInt(this.value); if (!isNaN(v) && v >= 1) setMultiplier(v); });

// â”€â”€ Break UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBreakDesc() {
  const desc = document.getElementById('breakDesc');
  if (!breakEnabled) { desc.style.display = 'none'; return; }
  desc.style.display = '';
  desc.textContent = breakMode === 'custom'
    ? 'Break = ' + breakCustomMin + ' min (fixed)'
    : 'Break = Â½ card value Ã— Â½ multiplier (â‰ˆ' + Math.round(multiplier * 0.5 * 10) / 10 + ' min per point)';
}
function saveBreakSettings() { ls_set(K_BREAK, { enabled: breakEnabled, mode: breakMode, custom: breakCustomMin }); }
function loadBreakSettings() {
  const s = ls_get(K_BREAK);
  if (s) { breakEnabled = s.enabled || false; breakMode = s.mode || 'half'; breakCustomMin = s.custom || 5; }
}
document.getElementById('breakToggle').addEventListener('change', function() {
  breakEnabled = this.checked;
  document.getElementById('breakOptions').classList.toggle('visible', breakEnabled);
  saveBreakSettings(); updateBreakDesc();
});
document.querySelectorAll('.break-mode-chip').forEach(c => {
  c.addEventListener('click', () => {
    document.querySelectorAll('.break-mode-chip').forEach(x => x.classList.remove('active'));
    c.classList.add('active'); breakMode = c.dataset.mode;
    document.getElementById('breakCustomWrap').classList.toggle('visible', breakMode === 'custom');
    saveBreakSettings(); updateBreakDesc();
  });
});
document.getElementById('breakCustomMin').addEventListener('input', function() {
  const v = parseInt(this.value); if (!isNaN(v) && v >= 1) { breakCustomMin = v; saveBreakSettings(); updateBreakDesc(); }
});

// â”€â”€ Alarm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var alarmCtx = null, alarmLoopId = null, alarmAutoStopId = null;
var ALARM_NOTES = [523,659,784,1047,784,659,523,523,659,784,1047,784,659,523,523,659,784,1047,784,659,523];
var ALARM_LOOP_MS = ALARM_NOTES.length * 220;
function playAlarm() {
  stopAlarm(); showAlarmPopup(); ensurePopupStyle();
  function loop() {
    try {
      alarmCtx = new (window.AudioContext || window.webkitAudioContext)();
      var t = alarmCtx.currentTime;
      ALARM_NOTES.forEach(freq => {
        var o = alarmCtx.createOscillator(), g = alarmCtx.createGain();
        o.connect(g); g.connect(alarmCtx.destination); o.type = 'sine';
        o.frequency.setValueAtTime(freq, t); g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.4, t+0.05); g.gain.exponentialRampToValueAtTime(0.001, t+0.3);
        o.start(t); o.stop(t+0.3); t += 0.22;
      });
    } catch(e) {}
    alarmLoopId = setTimeout(loop, ALARM_LOOP_MS);
  }
  loop(); alarmAutoStopId = setTimeout(stopAlarm, 30000);
}
function stopAlarm() {
  clearTimeout(alarmLoopId); alarmLoopId = null;
  clearTimeout(alarmAutoStopId); alarmAutoStopId = null;
  if (alarmCtx) { try { alarmCtx.close(); } catch(e) {} alarmCtx = null; }
  hideAlarmPopup();
}
function showAlarmPopup() {
  if (document.getElementById('alarmPopup')) return;
  const p = document.createElement('div'); p.id = 'alarmPopup';
  p.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:#2a2420;color:#fff;padding:14px 20px 14px 24px;border-radius:50px;display:flex;align-items:center;gap:14px;box-shadow:0 8px 32px rgba(0,0,0,0.35);z-index:9999;font-family:Lato,sans-serif;font-size:0.9rem;font-weight:700;animation:slideUpPopup .3s ease;';
  const msg = document.createElement('span'); msg.textContent = isOnBreak ? 'â˜• Break over!' : 'â° Time\'s up!';
  const btn = document.createElement('button'); btn.textContent = 'Stop Alarm';
  btn.style.cssText = 'background:var(--accent);color:#fff;border:none;border-radius:50px;padding:7px 18px;font-family:Lato,sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;';
  btn.addEventListener('click', stopAlarm);
  p.appendChild(msg); p.appendChild(btn); document.body.appendChild(p);
}
function hideAlarmPopup() { const p = document.getElementById('alarmPopup'); if (p) p.remove(); }

// â”€â”€ Pomodoro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var POMO_CIRC = 2 * Math.PI * 68;
var pomoSettings = { work: 25, short: 5, long: 15, longAfter: 4 };
var pomoMode = 'work', pomoTotalTime = 0, pomoRunning = false, pomoSessionCount = 0;

const pomoTicker = makeTicker(
  function(remaining, total) {
    document.getElementById('pomoTimerInner').textContent = formatTime(remaining);
    document.getElementById('pomoRingFill').style.strokeDashoffset = POMO_CIRC * (1 - remaining / total);
  },
  function() {
    pomoRunning = false;
    onPomoComplete();
  }
);

var POMO_META = {
  work:  { label: 'Focus Time',  sub: 'Stay focused!',          color: 'var(--pomo-work)',  cls: 'work'  },
  short: { label: 'Short Break', sub: 'Take a breather â˜•',     color: 'var(--pomo-short)', cls: 'short' },
  long:  { label: 'Long Break',  sub: 'Great job â€” rest up ğŸŒ¿', color: 'var(--pomo-long)',  cls: 'long'  },
};
function pomoDuration(m) { if (m==='work') return pomoSettings.work*60; if (m==='short') return pomoSettings.short*60; return pomoSettings.long*60; }

function pomoSetMode(mode, autoStart) {
  pomoTicker.stop(); pomoRunning = false; pomoMode = mode; pomoTotalTime = pomoDuration(mode);
  const m = POMO_META[mode];
  document.getElementById('pomoSessionLabel').textContent = m.label;
  document.getElementById('pomoSessionLabel').className = 'pomo-session-label ' + m.cls;
  document.getElementById('pomoSubLabel').textContent = m.sub;
  const rf = document.getElementById('pomoRingFill'); rf.style.stroke = m.color; rf.style.strokeDashoffset = '0';
  document.getElementById('pomoTimerInner').textContent = formatTime(pomoTotalTime);
  document.getElementById('pomoTimerInner').className = 'pomo-ring-inner';
  const sb = document.getElementById('pomoStartStopBtn'); sb.textContent = 'â–¶ Start'; sb.className = 'btn btn-pomo-' + m.cls;
  document.querySelectorAll('.pomo-mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
  updatePomoDots();
  if (autoStart) startPomoTimer();
}
function startPomoTimer() {
  pomoRunning = true;
  const m = POMO_META[pomoMode];
  document.getElementById('pomoStartStopBtn').textContent = 'â¸ Pause';
  document.getElementById('pomoTimerInner').className = 'pomo-ring-inner running ' + m.cls;
  // If the ticker has never been started (pausedRemaining is null) or was stopped,
  // always do a fresh start. Only resume if it has a paused mid-session value.
  if (pomoTicker.remaining() > 0) {
    pomoTicker.resume();
  } else {
    pomoTicker.start(pomoTotalTime);
  }
}
function pausePomoTimer() {
  pomoTicker.pause(); pomoRunning = false;
  document.getElementById('pomoStartStopBtn').textContent = 'â–¶ Start';
  document.getElementById('pomoTimerInner').className = 'pomo-ring-inner';
}
function onPomoComplete() {
  playAlarm();
  const subj = document.getElementById('pomoSubjectInput').value.trim();
  if (pomoMode === 'work') {
    const mins = pomoSettings.work;
    pomoStatsToday.pomos++; pomoStatsToday.focusMin += mins;
    pomoStatsAllTime.pomos++; pomoStatsAllTime.focusMin += mins;
    if (subj) { logPomoSession(subj, mins); addRecentSubject(subj); }
    touchStreak();
    notify('ğŸ… Focus complete!', (subj ? subj + ' â€” ' : '') + mins + ' minutes done.');
    pomoSessionCount++;
    const nxt = (pomoSessionCount % pomoSettings.longAfter === 0) ? 'long' : 'short';
    document.getElementById('pomoSubLabel').textContent = nxt === 'long' ? 'ğŸ‰ Long break time!' : 'ğŸ‰ Take a short break!';
    setTimeout(() => pomoSetMode(nxt, false), 1500);
  } else {
    const mins = pomoMode === 'short' ? pomoSettings.short : pomoSettings.long;
    pomoStatsToday.breakMin += mins; pomoStatsAllTime.breakMin += mins;
    notify('â˜• Break over!', 'Time to get back to work.');
    document.getElementById('pomoSubLabel').textContent = 'â° Back to work!';
    setTimeout(() => pomoSetMode('work', false), 1500);
  }
  savePomoStats(); renderPomoStats();
}
function updatePomoDots() {
  const dots = document.getElementById('pomoDots'); dots.innerHTML = '';
  for (let i = 0; i < pomoSettings.longAfter; i++) {
    const d = document.createElement('div'); d.className = 'pomo-dot';
    const idx = pomoSessionCount % pomoSettings.longAfter;
    if (i < idx) d.classList.add('done'); else if (i === idx && pomoMode === 'work') d.classList.add('current');
    dots.appendChild(d);
  }
}

// Stats period toggle
document.getElementById('statsTodayBtn').addEventListener('click', () => {
  statsPeriod = 'today';
  document.getElementById('statsTodayBtn').classList.add('active');
  document.getElementById('statsAllTimeBtn').classList.remove('active');
  renderPomoStats();
});
document.getElementById('statsAllTimeBtn').addEventListener('click', () => {
  statsPeriod = 'alltime';
  document.getElementById('statsAllTimeBtn').classList.add('active');
  document.getElementById('statsTodayBtn').classList.remove('active');
  renderPomoStats();
});

// Pomo buttons
document.getElementById('pomoStartStopBtn').addEventListener('click', () => { if (pomoRunning) pausePomoTimer(); else startPomoTimer(); });
document.getElementById('pomoResetBtn').addEventListener('click', () => {
  pomoTicker.stop(); pomoRunning = false;
  document.getElementById('pomoTimerInner').textContent = formatTime(pomoTotalTime);
  document.getElementById('pomoRingFill').style.strokeDashoffset = '0';
  document.getElementById('pomoSubLabel').textContent = POMO_META[pomoMode].sub;
  document.getElementById('pomoStartStopBtn').textContent = 'â–¶ Start';
  document.getElementById('pomoTimerInner').className = 'pomo-ring-inner';
});
document.getElementById('pomoSkipBtn').addEventListener('click', () => {
  pomoTicker.stop(); pomoRunning = false;
  // Skip = abandon. No time is credited â€” the session wasn't completed.
  if (pomoMode === 'work') {
    const nc = pomoSessionCount + 1, nxt = (nc % pomoSettings.longAfter === 0) ? 'long' : 'short';
    pomoSessionCount = nc;
    pomoSetMode(nxt, false);
  } else {
    pomoSetMode('work', false);
  }
});
document.querySelectorAll('.pomo-mode-btn').forEach(b => b.addEventListener('click', () => pomoSetMode(b.dataset.mode, false)));
document.getElementById('pomoApplyBtn').addEventListener('click', () => {
  const w = parseInt(document.getElementById('pomoWorkMin').value)  || 25,
        s = parseInt(document.getElementById('pomoShortMin').value) || 5,
        l = parseInt(document.getElementById('pomoLongMin').value)  || 15,
        la= parseInt(document.getElementById('pomoLongAfter').value)|| 4;
  pomoSettings = { work: Math.max(1,w), short: Math.max(1,s), long: Math.max(1,l), longAfter: Math.max(2,la) };
  pomoSetMode(pomoMode, false);
});

// â”€â”€ Trophy modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTrophyModal() {
  const u = getActiveUser();
  document.getElementById('trophyDecks').textContent  = u ? (u.deckCompletions || 0) : 0;
  document.getElementById('trophyCards').textContent  = countStudied(deck);
  document.getElementById('trophyStreak').textContent = getStreak().count + ' ğŸ”¥';

  // Progress bar
  const studied  = countStudied(deck);
  const cleared  = countCleared(deck);
  const pStudied = (studied / TOTAL * 100).toFixed(1);
  const pCleared = (cleared / TOTAL * 100).toFixed(1);
  document.getElementById('dpStudied').style.width = pStudied + '%';
  document.getElementById('dpCleared').style.width = pCleared + '%';
  document.getElementById('dpLabel1').textContent = studied + ' studied' + (cleared ? ' Â· ' + cleared + ' cleared' : '');
  document.getElementById('dpLabel2').textContent = (TOTAL - studied - cleared) + ' remaining';

  // Deck history
  const hist = getDeckHistory();
  const container = document.getElementById('deckHistoryList');
  renderHistoryList(container, hist, '');

  document.getElementById('trophyModalBackdrop').classList.add('visible');
}
document.getElementById('completionsBadge').addEventListener('click', openTrophyModal);
document.getElementById('trophyCloseBtn').addEventListener('click', () => document.getElementById('trophyModalBackdrop').classList.remove('visible'));
document.getElementById('trophyModalBackdrop').addEventListener('click', e => { if (e.target === document.getElementById('trophyModalBackdrop')) document.getElementById('trophyModalBackdrop').classList.remove('visible'); });

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
  const t = b.dataset.tab;
  document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(x => x.classList.remove('active'));
  b.classList.add('active'); document.getElementById('tab-' + t).classList.add('active');
}));

// â”€â”€ Deck buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('drawBtn').addEventListener('click', drawCard);
document.getElementById('startStopBtn').addEventListener('click', () => { if (deckTicker.isRunning()) pauseTimer(); else startTimer(); });
document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
document.getElementById('clearCardBtn').addEventListener('click', clearCard);
document.getElementById('skipBreakBtn').addEventListener('click', () => { endBreakPhase(); stopAlarm(); });
document.getElementById('resetDeckBtn').addEventListener('click', () => {
  if (!activeUserId) return;
  const u = getActiveUser();
  if (!confirm('Reset ' + (u ? u.name + "'s" : 'the') + ' full deck? All 54 cards will be restored.')) return;
  deckTicker.stop(); breakTicker.stop(); isOnBreak = false;
  document.getElementById('breakPhaseBanner').classList.remove('visible');
  document.getElementById('progressBar').classList.remove('break-fill');
  document.getElementById('skipBreakBtn').style.display = 'none';
  currentCard = null; deck = freshDeck(); persist(); restoreCardDisplay(); renderDeck();
});

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const modalBackdrop = document.getElementById('modalBackdrop');
const newUserInput  = document.getElementById('newUserInput');
document.getElementById('addUserBtn').addEventListener('click', () => { newUserInput.value = ''; modalBackdrop.classList.add('visible'); setTimeout(() => newUserInput.focus(), 100); });
document.getElementById('modalCancelBtn').addEventListener('click', () => modalBackdrop.classList.remove('visible'));
document.getElementById('modalConfirmBtn').addEventListener('click', () => {
  const n = newUserInput.value.trim(); if (!n) { newUserInput.focus(); return; }
  addUser(n); modalBackdrop.classList.remove('visible');
});
newUserInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('modalConfirmBtn').click();
  if (e.key === 'Escape') modalBackdrop.classList.remove('visible');
});
modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) modalBackdrop.classList.remove('visible'); });

const helpModalBackdrop = document.getElementById('helpModalBackdrop');
document.getElementById('helpBtn').addEventListener('click', () => helpModalBackdrop.classList.add('visible'));
document.getElementById('helpCloseBtn').addEventListener('click', () => helpModalBackdrop.classList.remove('visible'));
helpModalBackdrop.addEventListener('click', e => { if (e.target === helpModalBackdrop) helpModalBackdrop.classList.remove('visible'); });

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme));
  ls_set(K_THEME, theme);
}
document.querySelectorAll('.theme-btn').forEach(b => b.addEventListener('click', () => applyTheme(b.dataset.theme)));

// â”€â”€ Visibility catch-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState !== 'visible') return;
  if (isOnBreak && breakTicker.isRunning()) {
    const r = breakTicker.remaining();
    document.getElementById('timerDisplay').textContent = formatTime(r);
    if (currentCard) document.getElementById('progressBar').style.width = (r / (breakMinutesForCard(currentCard.rank) * 60) * 100) + '%';
  } else if (!isOnBreak && deckTicker.isRunning() && currentCard) {
    const r = deckTicker.remaining(), total = studyMinutes(currentCard.rank) * 60;
    document.getElementById('timerDisplay').textContent = formatTime(r);
    document.getElementById('progressBar').style.width = (r / total * 100) + '%';
  }
});

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  // Theme
  applyTheme(ls_get(K_THEME) || 'warm');

  // Multiplier
  const savedMult = ls_get(K_MULT);
  if (savedMult && savedMult >= 1) multiplier = savedMult;

  // Break settings
  loadBreakSettings();
  document.getElementById('breakToggle').checked = breakEnabled;
  if (breakEnabled) document.getElementById('breakOptions').classList.add('visible');
  document.querySelectorAll('.break-mode-chip').forEach(c => c.classList.toggle('active', c.dataset.mode === breakMode));
  if (breakMode === 'custom') document.getElementById('breakCustomWrap').classList.add('visible');
  document.getElementById('breakCustomMin').value = breakCustomMin;
  setMultiplier(multiplier);
  updateBreakDesc();

  // Users
  const meta = getStoredMeta();
  if (!meta.length) {
    const u = createUser('Me'); users = [u];
    saveStoredMeta([{ id: u.id, name: u.name }]); saveStoredUser(u.id, u); switchUser(u.id);
  } else {
    users = meta.map(m => { const d = getStoredUser(m.id); return d || { id: m.id, name: m.name, deck: freshDeck(), currentCard: null, deckCompletions: 0 }; });
    const last = getActiveId();
    switchUser(users.find(u => u.id === last) ? last : users[0].id);
  }

  // Streak & subjects
  checkStreakExpiry(); // reset if >24h since last activity
  renderStreakBadge();
  renderSubjectChips();

  // Pomo
  pomoSetMode('work', false);
  loadPomoStats(); renderPomoStats(); renderPomoHistory();
})();
</script>

<footer class="site-footer">
  <p>Made with â™  by <a href="https://huskyong.github.io/MyPortfolio/" target="_blank" rel="noopener">Harsh Desai</a></p>
</footer>
</body>
</html>